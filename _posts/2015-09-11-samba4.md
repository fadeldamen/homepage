---
layout: post
title: Samba 4 
snip:  Um novo horizonte
---

![Samba](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/logo-samba.png)


> **Esta é uma documentação não oficial** do Samba 4 que fora elaborada através de um estudo pessoal e experiências práticas que tenho tido com o Samba em ambiente de produção. Se houver por minha parte alguma informação errada, por favor, entre em contato para que eu possa corrigir ou me mande um **pull request**. As referências usadas para o estudo além da experiência laboratorial e prática, estão no rodapé.


### Capítulo 1

* **[História](#historia)**
* **[A origem do nome samba](#a-origem-do-nome-samba)**
* **[Histórico de versões](#historico-de-versoes)**
* **[A origem do nome samba](#a-origem-do-nome-samba)**

### Capítulo 2

* **[Conceitos iniciais](#conceitos-iniciais)**
* **[Compartilhamento de arquivos](#compartilhamento-de-arquivos)**
* **[Protocolos SMB e CIFS](#protocolos-smb-e-cifs)**
* **[Estrutura do Active Directory](#estrutura-do-active-directory)**
* **[Protocolos do Active Directory](#protocolos-do-active-directory)**

### Capítulo 3

* **[Requisitos e Preparação do Sistema Operacional](#requisitos-e-preparacao-do-sistema-operacional)**
* **[Instalação do virtualbox](#instalacao-do-virtualbox)**
* **[Instalação do Debian stable](#instalacao-do-debian)**

### Capítulo 4

* **[Configurando e instalando o Samba4 Active Directory](#)**
* **[Fontes do Samba](#)**
* **[Instalando Samba](#)**
* **[Promovendo Samba](#)**
* **[Samba como um controlador de dominio](#)**

### Capítulo 5

* **[Criando compartilhamento de arquivos e servidor de impressão](#)**
* **[Criando compartilhamento simples](#)**
* **[Opções para compartilhamentos](#)**
* **[Lixeira do samba](#)**
* **[Auditando acessos](#)**
* **[Usando ACLs para permissões avançadas no Linux](#)**
* **[Compartilhamento básico de impressora](#)**

### Capítulo 6

* **[Migrando um domínio samba 3 PDC para Samba 4 AD](#)**
* **[Samba Tools](#)**
* **[Upgrading](#)**
* **[Migrando Grupos](#)**

### Capítulo 7

* **[Administração e gerenciamento de usuários Samba 4 AD pelo Windows](#)**
* **[Instalando ferramentas remotas de administração no Windows](#)**
* **[Administration Tools & Support Tools](#)**
* **[Adicionando Usuários do samba4 AD](#)**
* **[Configurando perfil nomade (Roaming Profiles)](#)**
* **[Adicionando unidades organizacionais no domínio Samba](#)**
* **[Implementando Group Policies (GPO) em um domínio Samba](#)**

### Capítulo 8

* **[Samba4 como um domínio membro AD (Replica)](#)**
* **[Preparando integração domínio samba com AD](#)**
* **[Adicionando domínio samba em um controlador AD existente](#)**
* **[Verificação de entradas DNS para novo host](#)**
* **[Testes de replicação de diretórios](#)**

### Capítulo 9

* **[Backup e Recovery do Samba AD](#)**
* **[Estratégias de Backup e restore da base LDB e TDB](#)**
* **[Backup](#)**
* **[Restore](#)**

### História

Tudo começou há muito tempo, quando a IBM e a Sytec co-desenvolveu um sistema de rede simples projetado para a construção de pequenas redes locais. O sistema incluiu uma coisa chamada **[NetBIOS](https://pt.wikipedia.org/wiki/NetBIOS)**, ou Network Basic Input Output System, isto é, **Sistema Básico de Rede de Entrada/Saída**. NetBIOS era um pedaço de software que foi carregado na memória para fornecer uma interface entre os programas e o hardware de rede.

Foi incluso no NetBIOS um esquema de endereçamento que usava nomes de 16 bytes para identificar estações de trabalho e aplicações habilitadas para rede. Em seguida, a Microsoft adicionou recursos para o DOS que permitia o disco I/O ser redirecionado para a interface NetBIOS, **o que permitiu que o espaço em disco fosse compartilhável através da LAN**. O protocolo de compartilhamento de arquivos ficou conhecido como **[SMB](https://pt.wikipedia.org/wiki/Server_Message_Block)**, e agora **[CIFS](http://www.webopedia.com/TERM/C/CIFS.html)**.

Em 1985, o protocolo foi expandido, dando origem ao protocolo **[NetBEUI](https://pt.wikipedia.org/wiki/NetBEUI)**, que foi durante muito tempo o principal protocolo usado em redes locais, antes da popularização do TCP/IP. O SMB (Server Message Block) veio mais tarde, junto com o Windows 3.11. O protocolo SMB faz o compartilhamento de arquivos e impressoras em redes Microsoft, incluindo a navegação na rede, o estabelecimento de conexões e a transferência de dados. Ele utiliza o NetBIOS para a troca de mensagens entre os hosts e inclui uma versão atualizada do protocolo, que roda sobre o TCP/IP.

**[Andrew Tridgell](https://pt.wikipedia.org/wiki/Andrew_Tridgell)**, um australiano que na época era estudante do curso de PhD em ciências da computação da Universidade Nacional da Austrália, precisava rodar um software chamado **["eXcursion"](http://www.hpl.hp.com/hpjournal/dtj/vol4num1/vol4num1art7.pdf)**, no **[DEC](https://en.wikipedia.org/wiki/Digital_Equipment_Corporation)**, empresa que trabalhava, para interagir com o **[Patchworks](https://en.wikipedia.org/wiki/Pathworks)**, um software de compartilhamento de arquivos. O **[Patchworks](https://en.wikipedia.org/wiki/Pathworks)** era um software proprietário, que utilizava um protocolo obscuro, sobre o qual não existiam muitas informações disponíveis.

![Samba](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/andrew.jpg)

Como todo bom hacker, ele decidiu estudar o protocolo e assim desenvolver um servidor que pudesse rodar em seu PC. Ele desenvolveu então um **[sniffer](https://pt.wikipedia.org/wiki/Sniffing)**, chamado clockspy que era capaz de examinar o tráfego da rede e fez engenharia reversa no protocolo SMB e o implementou no Unix. Isso fez com que no servidor Unix aparecesse como um servidor de arquivos Windows em seu PC com DOS. Com isso, ele foi rapidamente capaz de implementar o suporte às principais chamadas e a desenvolver um programa servidor, que era capaz de conversar com os clientes rodando o Patchworks. O objetivo desta primeira versão era apenas resolver um problema doméstico: interligar um computador rodando o MS-DOS ao servidor rodando o **[Solaris](https://pt.wikipedia.org/wiki/Solaris)**.

O projeto começou a se tornar popular a partir da versão 1.6.09 que foi a primeira a trazer suporte ao controle de acesso com base nos logins de usuário (assim como o Windows NT), enquanto as versões anteriores suportavam apenas o controle de acesso com base no compartilhamento (assim como no Windows 3.11 e 95), onde a única opção de segurança era usar uma senha de acesso para os compartilhamentos. Para a época, foi um avanço extraordinário visto que tudo o que o samba oferecia, supria os serviços oferecidos pela Microsoft.

No entanto, em 1999 a Microsoft lançou o Active Directory que é implementado pela primeira vez no Microsoft Windows 2000 Server Edition e com melhorias significativas no Microsoft Windows Server 2003 e 2003 R2 e mais tarde no Windows Server 2008 e 2008 R2.

> Com isto, surgiu o desafio da comunidade que desenvolvia o Samba na época (e que desenvolve até hoje),a criar uma implementação de serviço de diretório usando um protocolo compatível com o LDAP que armazenasse informações sobre objetos na rede e ao mesmo tempo disponibilizasse essas informações a usuários e administradores da mesma rede. 

O problema é que o **[RFC](https://pt.wikipedia.org/wiki/Request_for_Comments)** (Request for Comments), isto é, o documento que descreve os padrões de cada protocolo de Internet antes de serem considerados um padrão, no caso do AD, não era de interessa por parte da Microsoft que estivesse aberto à comunidade como fora feito com o protocolo LDAP por exemplo. Com isto, a comunidade que desenvolve o Samba, não fazia ideia de como o AD funcionava. Basicamente, teriam que pesquisar, colocar mais sniffers em rede, fazer engenharia reversa e mais uma vez demorar anos e anos em desenvolvimento para criar uma solução alternativa ao AD.

Usando destes recursos, então, a comunidade começa a escrever uma nova versão pós a 3.6 do Samba em 2011. A **[versão 3.6](https://www.samba.org/samba/history/samba-3.6.25.html)** já trabalhava com o protocolo LDAP usando o OpenLDAP e o Kerberos em separado para alimentar as funcionalidades do Samba para que pudessem obter funcionalidades próximas ao AD. 

Depois de anos de desenvolvimento, a o que seria supostamente a versão 3.7 do Samba não chega nem a ser lançado e é descontinuado visto que em 2012, momento em que o Samba ainda estava em desenvolvimento, a Microsoft libera o RFC do AD e a comunidade desiste do desenvolvimento da nova versão do Samba e resolvem reescreve-lo do zero.

Nasce o **[Samba 4.0](https://www.samba.org/samba/history/samba-4.0.0.html)**. O Samba 4 compreende um servidor de diretório LDAP, um servidor de autenticação Kerberos, um servidor DNS dinâmico e implementações de todas as chamadas de procedimento remoto necessários para o Active Directory. Ele fornece tudo que é necessário para servir como um Active Directory Domain Controler compatível com todas as versões de clientes Microsoft Windows atualmente suportados pela Microsoft, incluindo o Windows 8 que foi lançado recentemente.O Samba agora permite implementar mecanismos de compartilhamento de arquivos e impressoras, sendo assim possível o acesso a recursos do Windows a partir do GNU/Linux.

![Samba](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/samba4.png)

Possibilidades com Samba4:

* Criar um AD Completo
* Criar um controlador de domínio Principal
* Criar um Controlador de domínio somente leitura (RODC)
* Criar um Controlador de domínio Adicional
* Pode ser administrado usando interface Gráfica do próprio Windows , como Usuários e computadores do Active Directory.
* Posso Migrar de forma fácil de AD Windows para um AD Linux e vice versa.
* É possível trabalhar com perfil móvel
* Trabalhar com Pasta Base
* Lixeira de Servidor de Arquivos (Tipo copia de Sombra)
* Auditoria de Acesso
* Trabalhar com permissões como a do Windows
* **Trabalhar com GPO**
* Fazer replicação de Servidores  (TIPO DFS)
* Trabalhar com dados em camadas
* Triagem de Arquivos  (Proibir gravação de arquivos pela extensão)
* Não precisa de CALs de acesso para as estações
* Posso fazer o SAMBA 4 trabalhar como controlador de domínio adicional do Windows server e vice versa.
* Já vem com DNS , kerberos, LDAP integrado.
* Posso fazer a integração do SAMBA 4 com o proxy Squid, pfSense e etc
* Adicionar usuários e configurações via linha de comando de maneira muito mais interativa e rápida.

---

### A origem do nome Samba
 
> O nome "Samba" surgiu a partir de uma simples busca dentro do dicionário **[Ispell](https://en.wikipedia.org/wiki/Ispell)** por palavras que possuíssem as letras S, M e B, de "Server Message Blocks", posicionadas nessa ordem. A busca retornou apenas as palavras "salmonberry", "samba", "sawtimber" e "scramble", de forma que a escolha do nome acabou sendo óbvia.

O comando que foi usado para consultar o dicionário Ispell no sistema:
{% highlight bash %} 
grep -i '^s.*m.*b' /usr/share/dict/words
{% endhighlight %}

---

### Histórico de Versões

A primeira versão a usar o nome Samba, foi a 1.6.05, que foi a sucessora imediata do "smbserver 1.6.4". O projeto anteriormente fora apresentado por **[Andrew Tridgell](https://pt.wikipedia.org/wiki/Andrew_Tridgell)** com o nome de **[nbserver 0.5](http://ftp.samba.org/ftp/samba/old-versions/server-05.tar.Z)** que foi o início do projeto que veio a tornar-se Samba mais tarde. Ao todo se considerar-mos os patches, o Samba contém mais de 50 versões até chegar a versão atual. Sem os patches e\ou versões no estilo **[CVS](https://pt.wikipedia.org/wiki/CVS)**, o Samba tem exatamente 4 versões desde a 1.x.x até a recente 4.x.x que podem ser visto no **[histórico de versões do samba](https://www.samba.org/samba/history/)**. O registro da primeira versão do que seria o samba hoje, foi anunciado por Andrew no google group e ainda pode ser visto **[aqui](https://groups.google.com/forum/#!msg/vmsnet.networks.desktop.pathworks/EmyZEGd5ZRA/nJtBfp6ak30J)**.

O importante aqui é destacar as mudanças mais significativas entre as versões até chegar no Samba4. Por exemplo: 

* **1.6.09** Foi a primeira versão a apoiar a segurança a nivel de usuário (o que fez do Samba um concorrente muito mais sério para o uso corporativo na época). 
* **1.7** Suportava a desconfiguração de nomes de arquivos para clientes mais antigos, bem como também foi a primeira versão a ter um FAQ. 
* **1.8** Esta versão foi a primeira a adicionar suporte primitivo para línguas estrangeiras.
* **1.9** Suporte de navegação mais aprimorado.
* **1.9.16** Foi quando foi adotado o **[CVS](https://pt.wikipedia.org/wiki/CVS)** o que permitiu que o Samba fosse desenvolvido mais rapidamente.
* **2.0** O Samba se tornou ainda mais popular e acessível aos usuários finais. Neste mesmo ano 1999, fora lançado o **[primeiro livro sobre o Samba](https://www.samba.org/samba/docs/using_samba/ch00.html)** que hoje faz parte da documentação oficial do mesmo.
* **2.2** Esta se torna a primeira versão estável do Samba. Nesta versão, já é possível criar um domínio primário para **[NT4](https://en.wikipedia.org/wiki/Windows_NT_4.0)**, suporta Windows 2000 e é melhorada a parte de infra-Estrutura para impressão **(graças ao apoio da HP)** e comunidade.
* **3.0** O principal diferencial da Samba 3.0 é que ele inclui suporte para autenticação Kerberos 5 e LDAP, que são obrigados a agir como clientes em um domínio do Active Directory. Outra característica que apareceu no Samba 3.0 é o suporte a Unicode, o que simplifica muito apoio às línguas internacionais. 

> A diferença é que os serviços LDAP, Kerberos e outros, não estão integrados ao Samba nesta versão como está na 4.Segundo Bartlett (2005, p. 57), o SAMBA 3.0 possuía a capacidade de entrar como usuário em uma rede operando com Active Directory. Esta funcionalidade foi o início dos trabalhos com Active Directory, que vieram a tona de forma mais convincente no SAMBA 4.

* **4.0** Esta versão introduz o aguardado suporte para a tecnologia Microsoft Active Directory através da implementação de uma combinação de um servidor de diretório LDAP, um servidor de autenticação Heimdal Kerberos, um serviço DNS dinâmico (através do seu próprio servidor DNS ou plugin BIND) e todo o procedimento de chamadas remotas necessárias para cumprir a função de um controlador de domínio do Active Directory (Active Directory Domain Controller) de todas as versões suportadas do Windows, incluindo o Windows 8.

> O Samba 4 fornece políticas de grupo (Group Policies), perfis móveis (Roaming Profiles) e outros recursos para administrar sistemas em um domínio do Windows, bem como integração com servidores Exchange e alternativas compatíveis em código aberto. O suporte do Samba ao Active Directory é completamente transparente para os clientes, o que significa que um controlador de domínio baseado em Samba pode ser integrado a domínios do Active Directory existentes. 

> Scripts de atualização são fornecidos pelos desenvolvedores do Samba para ajudar com uma migração “suave” de um recurso de controlador de domínio Windows NT no Samba 3.x.

> Os recursos de compatibilidade do Active Directory no Samba 4 foram criados com a ajuda da documentação oficial e testes de interoperabilidade da Microsoft. “Estamos satisfeitos que os laboratórios de documentação e de interoperabilidade fornecidos pela Microsoft tenham sido fundamentais no desenvolvimento do Samba 4.0 Active Directory. A Microsoft está empenhada em apoiar a interoperabilidade entre as plataformas”, disse **[Thomas Pfenning](https://www.linkedin.com/pub/thomas-pfenning/a/153/163)**, diretor de desenvolvimento do Windows Server. 

--- 

### Conceitos iniciais

Das muitas tecnologias de redes, uma das mais conhecidas para redes de computadores, especialmente aquelas que usam de forma homogênea o sistema operacional Windows, é o Active Directory. Por questões de praticidade e segurança, muitas redes de computadores Windows são configuradas com AD, mas isso originalmente implicava na utilização única e exclusiva de sistemas operacionais em toda a rede envolvida, ou pelo menos no servidor, cujas licenças sempre foram muito mais onerosas do que as versões de Windows para estações de trabalho. O SAMBA sempre buscou a interoperabilidade na comunicação entre sistemas heterogêneos.

Em sua versão 4, ganhou uma reimplementação em software livre do protocolo Active Directory, sendo desenvolvido por Andrew Tridgell, em conjunto com toda a comunidade de software livre. Esta inovação que permitiu que uma máquina com sistema operacional Unix possa cumprir o mesmo papel de um servidor Windows. 

Segundo a Microsoft, o Active Directory (AD) é um serviço de diretório desenvolvido pela empresa para o domínio das redes Windows e está incluído na maioria dos sistemas
operacionais Windows Server como um conjunto de processos e serviços (MICROSOFT DEVELOPMENT NETWORK, 2010). Esta tecnologia permite aos usuários de uma rede de computadores trabalharem usando entradas personalizadas de usuário e senha, não importando se o usuário decidir usar outro computador, suas configurações e arquivos pessoais poderão ser acessados, desde que tais máquinas estejam dentro de um mesmo domínio controlado por um servidor.

Segundo a Microsoft (How Active Directory Searches Work, 2010), o Active Directory é uma tecnologia de controle de domínio tradicionalmente implementada pela Microsoft nos sistemas operacionais Windows, baseada essencialmente na personalização do protocolo LDAP feito pela empresa.

AD é um controlador de domínio que autentica e autoriza todos os usuários e computadores em uma rede de tipo domínio do Windows, atribui e aplica as políticas de segurança para todos os computadores autenticados, como instalação e atualizações de software. O AD é usado em empresas com redes Windows, nas quais os administradores de redes escolheram utilizar este recurso como forma de centralizar a administração dos recursos, bem como da segurança.

Como facilidade, ele armazena centralmente os dados de usuários e computadores, permitindo que os usuários tenham apenas uma senha para acessar todos os recursos disponíveis na rede. O diretório também pode ser utilizado para compartilhamento de arquivos, impressoras, gerenciamento de atualizações de estações de trabalho através do **WSUS (Windows Server Update Services)**, tudo em um console simples e gerenciável. 

Quando um usuário faz logon em um computador que faz parte de um domínio de rede, o AD verifica a senha apresentada e determina se o usuário é um administrador de
sistema ou um utilizador normal. Uma instância do AD consiste em um banco de dados e o correspondente código executável responsável pelo atendimento de pedidos e a manutenção do banco de dados. A parte executável é chamada de Directory System Agent (DSA), que é uma coleção de serviços do Windows e processos que são executados no Windows 2000 e versões posteriores.

Os objetos no bancos de dados do AD podem ser acessados através do protocolo LDAP, o ADSI (interface dos COMs (Component Object Model) ) e dos serviços da APIs de
mensagens e o Gerenciador de Contas de Segurança. 

No Active Directory são encontrados objetos, florestas, arvores, domínios, partiçoes, esquemas e unidades organizacionais (similares a pastas). Uma estrutura de AD é um arranjo de informações sobre objetos. Os objetos se dividem em duas categorias principais:

* Recursos: Hardware em uma rede ex.: Impressoras
* Entidades de segurança: Entidades puramente lógicas ex.: Contas de usuário ou grupos.

Para cada entidade de segurança são atribuídos security identifiers (SIDs) únicos. Cada objeto representa uma única entidade: um usuário, um computador, uma impressora ou um grupo e seus atributos, e certos objetos podem conter outros objetos. 

Dentro de uma implantação, os objetos são agrupados em domínios. Os objetos para um único domínio são armazenados em uma única base de dados (que podem ser replicados).
Os domínios são identificados pelo seu o namespace (nome no DNS). Um domínio é definido como um grupo lógico de objetos de rede (usuários, dispositivos) que compartilham o mesmo banco de dados AD.

Uma árvore é uma coleção de um ou mais domínios, e árvores de domínio em um namespace contínuo, vinculados em uma hierarquia de confiança transitiva. Uma floresta é uma coleção de árvores que compartilham um catálogo global comum, esquemas de diretório, estruturas lógicas e a configuração do diretório. A floresta representa o limite de segurança dentro do qual os usuários, computadores, grupos e outros objetos são acessíveis. 

O banco de dados do AD está organizado em partições, cada um armazenando tipos de objetos específicos e seguindo um padrão de replicação. A partição schema contém a definição de classes de objetos e atributos dentro da Floresta. A partição Configuration contém informações sobre a estrutura física e de configuração da floresta (como a topologia física). Ambos replicam para todos os domínios da floresta. A partição do domínio detém todos os objetos criados nesse domínio e replica somente dentro de seu próprio domínio. 

Os objetos mantidos dentro de um domínio podem ser agrupados em Organizational Units (OUs). OUs é o nível recomendado de a aplicação de políticas de grupo, que são objetos do AD chamados formalmente **Group Policy Objects (GPOs)**, embora as políticas também podem ser aplicadas a domínios ou sites. A UO é o nível em que os poderes administrativos são comumente delegados, mas a delegação pode ser executada com os objetos individuais ou com os atributos também.

> Não é possível, criar contas de usuários com um nome de usuário idêntico em OUs separadas. Isto é assim porque o atributo de objeto de usuário (sAMAccountName), deve ser exclusivo dentro do domínio. Dois usuários em diferentes OUs podem ter o mesmo Common Name (o nome sob o qual eles são armazenados no próprio diretório).

> A razão para este problema de nomes duplicados através de diretórios hierárquicos, é que a Microsoft baseia-se nos princípios do NetBIOS, que é um método de gerenciamento de objetos de redes de arquivos simples, que vem desde o Windows NT 3.1 e MS-DOS LAN Manager. Permitir a duplicação de nomes de objetos no diretório, ou remover completamente o uso de nomes de NetBIOS, impediria a compatibilidade com softwares e equipamentos legados.

**O Volume de Sistema (SYSVOL)** que é um diretório compartilhado que armazena a cópia do servidor de arquivos de domínio público, que deve ser compartilhado para acesso e replicação em domínios comuns. Ela contém:

* O Logon de rede compartilhado. Hospedam scripts de logon e objetos de diretiva
dos computadores clientes.
* Scripts de logon de usuário, para os domínios em que o administrador usa as
opções “Usuários e Computadores” do Active Directory.
* Diretivas de grupo do Windows.
* Os arquivos de transferências, das pastas e arquivos que devem estar disponíveis e
sincronizados entre os controladores dos domínios de serviço de replicação (FRS).
* Junções de sistema de arquivo. Segundo a Microsoft, o recomendável é instalar esses 3 em locais distintos, preferencialmente em HDs separados, para facilitar a recuperação do sistema em caso de falha de hardware. Se a floresta está no nível de funcionalidade do Windows Server 2008 ou Windows Server 2008 R2, o sistema de replicação de SYSVOL deixa de ser o NT File Replication. 
* Service (NTFRS) e passa a ser o Distributed File System Replication (DFSR), o que termina criando uma dependência de uma versão específica de sistema operacional Windows.

Depois de 10 anos de trabalho e 6 anos da liberação da última versão principal, os desenvolvedores do Samba anunciaram o lançamento do Samba 4.0, a versão mais recente da implementação em software livre do protocolo Server Message Block (SMB).  Outras características do Samba 4 incluem a primeira implementação em software livre da versão 2.1 do protocolo SMB de compartilhamento de arquivos da Microsoft e uma implementação inicial do SMB3 que será desenvolvido em versões futuras da ramificação do Samba 4. 

Por padrão, o servidor smbd do Samba 3 é utilizado para todos os serviço de arquivos. Para casos de uso como um controlador de domínio do Active Directory, o servidor de arquivos NTVFS é fornecido da forma como foi utilizado nos primeiros betas do Samba 4 e é mais recomendável para esta tarefa. A integração segura e incorporada ao NTP fornece **[timestamps](https://pt.wikipedia.org/wiki/Marca_temporal)** mais precisos para clientes Windows.

---

### Compartilhamento de arquivos

Uma das características mais poderosas do Samba é a sua capacidade de compartilhar arquivos e pastas entre o servidor e o cliente. O Samba fornece tudo isso como uma solução de código aberto desde a versão 3 está em um estado muito maduro. Usuários e administradores de sistemas que usaram a versão 3 e versões anteriores do Samba, vão ver que na versão 4, os recursos de compartilhamento de arquivos são muito mais fáceis de implementar e gerenciar. 

De forma simplificada, para compartilharmos uma pasta e\ou arquivo no Samba4, basta criar-mos alguns parâmetros simples no smb.conf e\ou usar algum client gráfico, ambiente facilitador para tal. No entanto, como este artigo é focado em administradores, logo, **faremos tudo por linha de comando**:

{% highlight bash %} 
mkdir ~/pasta

# Abra seu smb.conf 
vim /etc/samba/smb.conf

# Crie as seguintes linhas:
[PASTA]
comment = Pasta teste
path = ~/pasta
read only = No

# Por fim, reinicie as configurações do samba
smbcontrol all reload-config
{% endhighlight %}

Neste momento, já podemos acessar o diretório usando o Microsoft Windows em nosso domínio (por exemplo, como administrador) e configurar todas as permissões que quizermos. Além disso, usuários e grupos podem diretamente acessar o compartilhamento criado. Como Samba 4 é compatível com o Active Directory, não precisa usar qualquer modelo antigo para restringir o acesso do usuário no arquivo smb.conf. Mais a frente neste artigo, veremos detalhadamente como é feito o compartilhamento entre diretórios, arquivos, impressoras, com permissões e muito mais.

---

### Protocolos SMB e CIFS

O protocolo SMB desenvolvido inicialmente por **[Barry Feigenbaum](https://www.linkedin.com/in/barryfeigenbaum)** na IBM, na década de 80. Exigia, nessa época, uma camada de API Application Programming Interface denominada Network Basic Input/Output System **(NetBIOS)** fornecendo serviços tais como resolução de nome e navegação de rede. Posteriormente implementado, ou adotado, pela Microsoft em função da expansão de seus produtos na década de 90 focando as redes de computadores.

Na evolução do desenvolvimento do SMB, pela Microsoft, criou-se uma versão chamada CIFS **(Common Internet File System)** para padronizar com a Internet Engineering Task Force **(IETF)** recebendo o nome final de **SMB/CIFS** (tecnicamente um "dialeto" do SMB) em 1996. 

O Windows for WorkGroups foi o primeiro sistema da Microsoft a adotar o SMB/CIFS. Como o protocolo predominante foi o TCP/IP e para a resolução de nomes a Microsoft teve que adotar o DNS (Domain Name System) fez com o SMB tivesse que ser executado diretamente sobre o TCP/IP na modalidade denominada hosting direto (utiliza-se TCP e UDP na porta 445). Portanto, em redes Windows, o SMB/CIFS se transformou em um padrão para a manipulação de arquivos entre máquinas, praticamente sendo o "núcleo de rede nativo" da Microsoft.

O SMB, que significa Server Message Block, é um protocolo para compartilhamento de arquivos, impressoras, portas seriais e abstrações de comunicação. SMB é um protocolo cliente-servidor. O diagrama a baixo, ilustra a maneira pela qual funciona SMB. Os servidores disponibilizam sistemas de arquivos e outros recursos (impressoras, processadores de mensagens, pipes nomeados APIs) disponíveis para os clientes da rede. Os computadores clientes podem ter seus próprios discos rígidos, mas eles também querem o acesso aos sistemas de arquivos compartilhados e impressoras nos servidores.

![SMB](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/smb1.png)

Basicamente o cliente se conecta ao servidor que utiliza o protocolo TCP/IP (na verdade, se conecta ao NetBIOS sobre o TCP/IP, conforme especificado no **[RFC1001](http://tools.ietf.org/html/rfc1001)** e **[RFC1002](http://tools.ietf.org/html/rfc1002)**), NetBEUI ou IPX/SPX. Depois de terem estabelecido uma conexão, o cliente pode, em seguida, enviar comandos (SMBs) para o servidor o que lhe permite abrir arquivos, ler e escrever, é possível fazer todo o tipo de coisa dentro de um servidor de arquivos. No entanto, no caso do SMB, estas coisas são feitas através da rede.

O protocolo SMB embora tenha outras funções associadas a ele, primordialmente tem como funcionalidade o de compartilhamento de arquivos, mas é possível também o compartilhamento de impressoras e definir níveis de segurança e autenticação. Por ser muito usado nos sistemas operacionais da Microsoft a versão do SMB, denominado SMB/CIFS, é um protocolo muito comum em diversos tipos de máquinas e sistemas para o compartilhamento de arquivos. 

O SMB pela perspectiva do Modelo OSI está na camada de aplicação e utiliza nomes de até 15 caracteres para definir endereços de máquina em uma rede. A Microsoft chegou ainda a desenvolver o SMB2 juntamente com o lançamento do Windows Vista. 

Andrew Tridgell utilizando da engenharia reversa em cima do protocolo SMB implementou no sistema operacional Unix e fazendo com que o servidor Unix aparecesse como sendo um servidor de arquivos Windows em seu computador com DOS. O Samba foi viabilizado por meio do protocolo **[NBT](https://pt.wikipedia.org/wiki/NetBIOS)**, de 1987, que emula redes locais NetBIOS sobre redes TCP/IP. O NBNS (mais conhecido tecnicamente por WINS - Windows Internet Name Server, ou ainda NBT) cria praticamente uma lista cruzada de endereços IP e nomes NetBios facilitando dessa forma a comunicação entre máquinas e sistemas distintos.

---

### Estrutura do Active Directory

Um serviço de diretório pode se explicado com várias ilustrações, mas a ilustração que, em minha opinião, mais demonstra o verdadeiro sentido de um serviço de diretório é a figura de uma lista telefônica ou uma agenda pessoal.Em nossa agenda podemos organizar, dias, semanas, meses e até anos, passando por pessoas, nomes, sobrenomes, datas de aniversário, dados importantes dentre outros. 

O serviço de diretório tem exatamente o mesmo sentido, o sentido de organizar e principalmente ter um local centralizado para a busca de informações necessárias no dia a dia, para nossos trabalhos.

Quando criamos um novo usuário, estamos utilizando o serviço de diretório, nesta base de dados (agenda), estamos guardando, nomes, sobrenomes, endereços, logins, senhas, grupos, ao qual o usuário pertence dentre outras tantas opções que podemos cadastrar, tudo isto ficará disponível dentro de uma base de dados, esta base de dados poderá ser utilizada pelos nossos servidores para vários trabalhos. Vamos citar três soluções de serviço de diretório:

* Open Ldap para Sistemas Open Source.
* EDirectory para Sistemas Novell.
* Active Directory para Sistemas Microsoft e com suporte para todos acima citados.

No mercado de hoje nossos negócios precisam ter informações rápidas, de fácil atualização, alta disponibilidade e principalmente muita segurança e o Active Directory pode nos oferecer todos estes atributos e muito mais...O Active Directory assumiu o mercado de serviços de diretório pelo seu desempenho, segurança e principalmente disponibilidade, o Active Directory esta no mercado desde o lançamento do Windows 2000 Server, após o seu nascimento assumiu a liderança dos serviços de diretório, utilizando como base o LDAP e a comunicação através de replicação lançou vários atributos e principalmente ferramentas para facilitar o gerenciamento de informações nas empresas.

Hoje quando usamos um usuário para logar no domínio de nossa empresa, estamos utilizando um serviço de diretório e por consequência usando o Active Directory.
Abaixo temos uma figura para demonstrar todos os recursos que o Active Directory pode utilizar como serviço de diretório de sua empresa:


![SMB](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/ad1.png)


Se perguntarmos a qualquer especialista ou Instrutor Microsoft (MCT), creio que esta deve ser a pergunta Top sem nenhuma chance de segunda colocada, pensando nisto desenhei a estrutura abaixo para podermos explicar esta informação. Bem, antes de mais nada, não é a mesma coisa! 

A cima, comparamos o AD com uma agenda, o AD físicamente também tem um banco de dados, este banco é conhecido com **NTDS.dit** e esta localizado na pasta %SystemRoot%\NTDS\ntds.dit em uma instalação default do AD. Este diretório chamado de NTDS apenas existirá nos servidores que tenham a função de Domain Controllers (DC’s). Neste diretório existirão os arquivos relacionados abaixo. Durante o processo de instalação do Active Directory **da Microsoft**, são criados cinco arquivos:

* Ntds.dit - Arquivo de banco de dados do AD
* Edb.log - Arquivo onde são armazenados todas as transações feitas no AD.
* Edb.chk - Arquivo de checkpoint controla transações no arquivo Edb.log já foram comitadas no arquivo Ntds.dit.
* Res1.log - Arquivo de reserva assegura que alterações sejam gravadas na base(Ntds.dit) no caso de falta de espaço em disco.
* Res2.log - Arquivo de reserva assegura que alterações sejam gravadas na base(Ntds.dit) no caso de falta de espaço em disco.

Bem, agora sabemos que a estrutura lógica do AD é gravada em uma base de dados física chamada de Ntds.dit, porém DC é AD? Não é claro que não, no desenho abaixo demonstramos claramente a diferença entre AD (estrutura lógica do AD) e DC (Servidor que contém uma cópia do NTDS.dit do AD). No desenho abaixo imaginemos uma construção, estamos construindo um grande salão de festas. Imaginem que nosso teto (retângulo azul) é nosso Active Directory, porém precisamos apoiar este teto em pilares (cilindros vermelhos), caso contrário nosso teto irá desabar, certo?

![SMB](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/ad2.png)

É isto mesmo, o Active Directory é a estrutura lógica (teto), e os DC’s são servidores fisicos (pilares), por isto a necessidade de termos muitos DC’s espalhados. Assim nosso AD mesmo na falha de um DC (pilar) ou vários DC’s ainda conseguirá responder as solicitações e pedidos de nossa infraestrutura.

![SMB](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/ad3.png)

Isto só é possível pois cada servidor quando recebe a função de Domain Controller, herda a criação do diretório %SystemRoot%\NTDS\ e toda a estrutura comentada acima. Todos os dados criados originalmente são replicados para o novo DC criado. Assim em um AD (domínio) com três DC’s como na figura abaixo, todos os Dc’s estão atualizados com todos os dados igualmente, isto recebe o nome de replicação do Active Directory.

![SMB](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/ad4.png)

O Serviço de Diretório do AD é divido em duas estruturas a estrutura lógica e a estrutura física, o conhecimento pleno sobre a estrutura do AD é muito importante, principalmente quando maior for sua estrutura. Nestas explicações informaremos algumas ferramentas que podem auxiliar na verificação deste processo, vale lembrar que estamos focando as explicações no Active Directory do Windows Server 2008 R2, porém estas explicações poderão ser utilizadas em qualquer uma das versões de Active Directory, nos próximos artigos falaremos das evoluções para as futuras versões.

Quando falamos de estrutura lógica do Active Directory, muitos termos são falados, a estrutura lógica do AD consiste em Objetos, Unidades Organizacionais, Domínio, Árvores de Domínio e Floresta. Utilizamos a estrutura lógica do AD para podermos gerenciar os objetos dentro da organização. Já os objetos, são os componentes mais básicos da estrutura lógica e representam, usuários, computadores e impressoras. 

No caso do OU (Unidades Organizacionais), é um objeto de container, utilizado para organizar outros objetos. A organização pode ser feita de várias formas.
Geográfica – Onde as OU’s representam Estadas ou Cidades de sua estrutura física Exemplo: OU SP - OU RJ Setorial – Onde as OU’s representam setores da estrutura física da empresa, por unidade de negócio. Exemplo: OU Administrativo – OU Produção Departamental – Onde as OU’s representam setores da estrutura física da empresa por departamento. Exemplo: OU RH – OU DP – OU Caldeira Híbrido – Modelo onde podemos interagir todos os modelos acima, na Figura abaixo temos um modelo disto.

![SMB](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/ad5.png)

O domínio é a estrutura mais importante do Active Directory e tem 2 funções principais.

* Fecham um limite administrativo para objetos. “Quem esta fora não entra, quem esta dentro não sai”, claro que esta regra pode sofrer alteração mediante permissões de entrada e saída, como relações de confiança.
* Gerenciam a segurança de contas e recursos dentro do Active Directory

Vale lembrar que um domínio do Active Directory compartilham:

* Mesmo banco de dados Ntds.dit com cada Domain Controller dentro deste domínio.
* Diretivas de segurança.
* Relações de Confiança com outros domínios.

Quando precisamos criar um segundo domínio, na maioria das vezes por necessidades no processo de segurança temos o que chamamos de domínios filhos. Quando temos um domínio pai com seus domínios filhos, chamamos de árvore de domínio, pois dividem o mesmo sufixo DNS, porém em distribuição hierárquica. Abaixo colocamos um exemplo para ilustrar nossa explicação. Criamos o domínio livemotion.local (Figura esquerda abaixo), para podermos configurar diretivas de segurança, em um dado momento, precisamos criar um domínio novo, que tenha acesso aos recursos do domínio livemotion.local, porém tenha suas próprias necessidades de segurança (Figura direita abaixo).

![SMB](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/ad6.png)

Conforme as figuras acima, podemos ver que quando temos um domínio filho, imediatamente estamos vinculados a um domínio pai, e esta divisão hierárquica de nome chamamos de Árvore de Domínios.O primeiro domínio de uma Floresta, chamamos de Root Domain, a Floresta receberá o nome deste domínio, a floresta pode ser feita de um único domínio com também estar dividida com várias árvores dentro da mesma floresta.

![SMB](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/ad7.png)

Quando falamos de estrutura física do Active Directory, alguns termos são utilizados, a estrutura física do AD consiste em Domain Controllers e Sites.
A estrutura física do AD é totalmente independente da estrutura lógica do AD. A estrutura física é responsável por timizar o tráfego de rede e manter segurança em locais físicos distintos. Um Domain Controller ou DC tem a função de executar o Active Directory e também armazenar a base do Active Directory bem como Replicar esta base “alterações” com outros DC’s.

Quando falamos de Árvores de Domínio ou até mesmo Floresta, vale lembrar que um DC pode apenas suportar um único domínio. Para criar uma disponibilidade do Active Directory podemos ter mais de um DC, sendo assim num exemplo de 2 Dc’s temos a base do Active Directory sendo replicada de forma perfeita entre os dois Dc’s.
A base do Active Directory o NTDS.dit é divido em partições, conforme a figura demonstrada abaixo:

![SMB](https://raw.githubusercontent.com/lobocode/lobocode.github.io/master/media/ad8.png)

Estas partições formam o arquivo NTDS.dit, este é replicado entre cada um dos DC’s de seu domínio, consequentemente o arquivo é replicado para cada DC, tendo todos os Dc’s sincronizados logo teremos um Active Directory saudável e que pode suprir a falha de um DC, sem afetar o serviço de diretório do domínio.

---

### Protocolos do Active Directory

* **LDAP**
&minus; O protocolo LDAP (protocolo de acesso a pastas leves) é um protocolo de comunicação desenvolvido para uso em redes TCP/IP. O protocolo LDAP define a forma como um cliente de diretório pode acessar um servidor de diretório e a forma como o cliente pode executar as operações de diretório e compartilhar dados de diretório. Os padrões LDAP são estabelecidos por grupos de trabalho da equipe Internet Engineering Task Force (IETF). O Active Directory implementa as especificações de rascunho de atributos LDAP e os padrões IETF para o LDAP versões 2 e 3. 

> Como está implícito em seu nome, o LDAP foi desenvolvido como um método eficaz para o acesso a serviços de diretório sem a complexidade de outros protocolos de serviços de diretório. Como o LDAP define as operações que podem ser executadas para consultar e modificar informações em um diretório, e a forma como as informações em um diretório podem ser acessadas com segurança, você pode usá-lo para localizar ou enumerar objetos de diretório e para consultar ou administrar o Active Directory.

> O projeto OpenLDAP foi iniciado em 1998 por **[Kurt Zeilenga](http://www.openldap.org/project/kurt/)**. O projecto começou por clonagem a fonte de referência LDAP a partir da Universidade de Michigan, onde um projeto de longa duração tinha apoiado o desenvolvimento e evolução do protocolo LDAP até que o projeto de final, lançar em 1996.

> O **clapd** é um simples daemon LDAP Connectionless, escrito como parte do esforço de pesquisa da IBM e concebido para responder às solicitações básicas que um cliente Windows faz. O clapd foi reescrito no Samba4.

* **DNS**
&minus; O Domain Name System ( DNS ) é um sistema de gerenciamento de nomes hierárquico e distribuído para computadores, serviços ou qualquer recurso conectado à Internet ou em uma rede privada. Ele baseia-se em nomes hierárquicos e permite a inscrição de vários dados digitados além do nome do host e seu IP. Em virtude do banco de dados de DNS ser distribuído, seu tamanho é ilimitado e o desempenho não degrada tanto quando se adiciona mais servidores nele. Este tipo de servidor usa como porta padrão a 53. A implementação do DNS-Berkeley, foi desenvolvido originalmente para o sistema operacional BSD UNIX 4.3.

> Um domínio do Active Directory é fortemente baseado em um domínio DNS, particularmente devido à forte integração entre o Kerberos e DNS, e o fato de que este permite uma mudança para a hierarquia de nomes. 

&minus;  O servidor DNS traduz nomes para os endereços IP e endereços IP para nomes respectivos, e permitindo a localização de hosts em um domínio determinado. Num sistema livre o serviço é implementado pelo software BIND. Esse serviço geralmente se encontra localizado no servidor DNS primário. O servidor DNS secundário é uma espécie de cópia de segurança do servidor DNS primário. Assim, ele se torna parte necessária para quem que usar a internet de uma forma mais fácil e evita que hackers roubem seus dados pessoais.

* **SNTP**
&minus;  O NTP é um protocolo para sincronização dos relógios dos computadores baseado no UDP para sincronização do relógio de um conjunto de computadores em redes de dados com latência variável. O NTP permite manter o relógio de um computador com a hora sempre certa e com grande exatidão. Originalmente idealizado por David L. Mills da Universidade do Delaware e ainda hoje mantido por si e por uma equipa de voluntários, o NTP foi utilizado pela primeira vez antes de 1985, sendo ainda hoje muito popular e um dos mais antigos protocolos da internet.

* **Kerberos**
&minus;  Kerberos é o nome de um Protocolo de rede, que permite comunicações individuais seguras e identificadas, em uma rede insegura. O protocolo Kerberos previne Eavesdropping e Replay attack, e ainda garante a integridade dos dados. Seus projetistas inicialmente o modelaram na arquitetura cliente-servidor, e é possível a autenticação mutua entre o cliente e o servidor, permitindo assim que ambos se autentiquem. O Kerberos necessita que os relógios internos dos clientes estejam sincronizados com o dele. Na configuração padrão, é necessário que os relógios dos clientes não tenham uma diferença maior do que 10 minutos. Na prática, servidores NTP são utilizados para manter os relógios do servidor e dos clientes sincronizados.

> Heimdal Kerberos é uma implementação open source do protocolo Kerberos. 


&minus;  SMB/CIFS. O SMB/CIFS (Server Message Block/Common Internet File System) é um protocolo de redes cujo o uso mais comum como foi dito anteriormente é o compartilhamento de arquivos em uma LAN. Para mais detalhes sobre este protocolo, vá em **[Protocolos SMB e CIFS](#protocolos-smb-e-cifs)**. 

* **NetBIOS**
&minus;  


* **IPC**
&minus;  


* **DCE/RPC**
&minus;



  

Lista de abreviaturas e siglas:

* **LDAP**: Lightweight Directory Access Protocol (ou Protocolo Leve de Acesso a
Diretórios)
* **AD**: Active Directory (ou Diretório Ativo)
* **RFC**: Request for Comments (ou Pedido para Comentários)
* **DFS**: Distributed File System (ou Sistema de Arquivo Distribuído)
* **DNS**: Domain Name System (ou Sistema de Nomes de Domínio)
* **NetBIOS**: Network Basic Input/Output System (ou Sistema Básico de Entrada/Saída
de Rede)
* **UCL**: User Account Control (ou Controle de Conta de Usuário)
* **PDC**: Primary Domain Controller (ou Controlador Primário de Domínio)

















